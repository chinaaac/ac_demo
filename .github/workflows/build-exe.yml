name: Build Python to EXE and Update Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write  # å¿…é¡»çš„å†™æƒé™

    steps:
    - uses: actions/checkout@v4

    # å…³é”®ï¼šä½¿ç”¨ç¨³å®šçš„ Python ç‰ˆæœ¬ï¼ˆ3.14 å¤ªæ–°ï¼Œå…¼å®¹æ€§å·®ï¼‰
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14.0'  # ç»è¿‡éªŒè¯çš„ç¨³å®šç‰ˆæœ¬

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        pip install pyinstaller

    - name: Build EXE
      run: |
        pyinstaller --onefile --name MyApp main.py  # æ— çª—å£æ¨¡å¼å¯åŠ  --windowed

    # ä¸Šä¼ æµ‹è¯•ç”¨äº§ç‰©ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
    - name: Upload test artifact
      uses: actions/upload-artifact@v4
      with:
        name: myapp-exe-test
        path: dist/MyApp.exe

    # é…ç½® Git èº«ä»½ï¼ˆç”¨äºæ¨é€æ ‡ç­¾ï¼‰
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    # å¼ºåˆ¶æ›´æ–° latest æ ‡ç­¾
    - name: Update latest tag
      run: |
        git tag -f latest
        git push -f origin latest  # è¦†ç›–è¿œç¨‹æ ‡ç­¾

    # å…³é”®ä¿®å¤ï¼šPowerShell è¯­æ³•é€‚é…
    - name: Create/Update Release (PowerShell å…¼å®¹)
      run: |
        # 1. åˆ é™¤ç°æœ‰ Releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        try {
          gh release delete latest -y
          Write-Host "Old release deleted successfully"
        }
        catch {
          Write-Host "No existing release to delete"
        }
        
        # 2. åˆ›å»ºæ–° Releaseï¼ˆPowerShell å¤šè¡Œè¯­æ³•ï¼‰
        gh release create latest ./dist/MyApp.exe `
          --title "Latest Build" `
          --notes "## Automated Build`n`n- Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n- Commit: ${{ github.sha }}`n- Branch: ${{ github.ref_name }}`n- Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" `
          --latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # è¾“å‡ºç»“æœæç¤º
    - name: Show completion info
      run: |
        Write-Host "âœ… Build and Release completed!"
        Write-Host "ğŸ“¥ Download from: https://github.com/${{ github.repository }}/releases/tag/latest"