name: Build Python to EXE and Update Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14.0'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if (Test-Path requirements.txt) { pip install -r requirements.txt }
        pip install pyinstaller

    - name: Build EXE
      run: |
        pyinstaller --onefile --name MyApp main.py

    - name: Upload artifact for testing
      uses: actions/upload-artifact@v4
      with:
        name: myapp-exe
        path: dist/MyApp.exe

    # 使用更简单的方法：直接覆盖标签
    - name: Update latest tag
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        git tag -f latest
        git push -f origin latest

    # 使用GitHub CLI创建Release（更可靠）
    - name: Create or update Release
      run: |
        # 删除现有的Release（如果存在）
        gh release delete latest -y || echo "No existing release to delete"
        
        # 创建新的Release
        gh release create latest ./dist/MyApp.exe \
          --title "Latest Build" \
          --notes "Automated build from ${{ github.sha }}" \
          --latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show build info
      run: |
        echo "Build completed successfully!"
        echo "Check the Releases page for the latest build."